(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7935],{24420:(e,a,r)=>{"use strict";r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{default:()=>k});var s=r(95155),l=r(12115),i=r(20063),n=r(22663),c=r(86948),d=r(76733),o=r(43698),u=r(30304),x=r(49156),m=r(60848),h=r(8723),g=r(94325),p=r(99145),v=r(41405),f=r(90854),y=r(25753),j=e([x,m,v,f]);function k(){var e,a,t;let j=(0,i.useRouter)(),k=(0,i.useParams)(),{user:b}=(0,f.A)(),{loadTicket:N,joinTicketRoom:A,leaveTicketRoom:w}=(0,v.d)(),E=(0,y.zr)(),[M,R]=(0,l.useState)(null),[C,O]=(0,l.useState)(!0),[S,D]=(0,l.useState)(""),[B,L]=(0,l.useState)(!1),[T,I]=(0,l.useState)([]),[z,F]=(0,l.useState)("ABERTO"),[P,_]=(0,l.useState)("MEDIA"),[V,U]=(0,l.useState)(!1),q=(0,l.useRef)(null),H=(0,l.useRef)(null),G=(0,l.useRef)(null),W=parseInt(k.id),J=(0,l.useCallback)(async()=>{try{O(!0);let e=await N(W);e?R(e):(n.oR.error("Ticket n\xe3o encontrado"),j.push("/dashboard/admin/tickets"))}catch(e){console.error("Erro ao carregar ticket:",e),n.oR.error("Erro ao carregar ticket"),j.push("/dashboard/admin/tickets")}finally{O(!1)}},[N,W,j]);(0,l.useEffect)(()=>{if(W)return J(),A(W),(async()=>{let{cookies:e}=await Promise.resolve().then(r.bind(r,6829)),a=e.token.get();if(E&&a){let{io:e}=await Promise.resolve().then(r.bind(r,9829)),t=e(E,{auth:{token:a},transports:["websocket","polling"]});t.on("ticket:nova-mensagem",e=>{e.ticketId===W&&e.ticket&&R(e.ticket)}),t.on("ticket:status-atualizado",e=>{e.ticketId===W&&(R(a=>a?{...a,status:e.status}:null),F(e.status))}),H.current=t}})(),()=>{w(W),H.current&&H.current.close()}},[W,A,w,J,E]),(0,l.useEffect)(()=>{M&&(F(M.status),_(M.prioridade))},[M]),(0,l.useEffect)(()=>{if((null==M?void 0:M.mensagens)&&M.mensagens.length>0){var e;null==(e=q.current)||e.scrollIntoView({behavior:"smooth"})}},[null==M?void 0:M.mensagens]);let K=async()=>{if(M&&(M.status!==z||M.prioridade!==P)){U(!0);try{await x.$p.ticket.update(M.id,{status:z,prioridade:P}),n.oR.success("Ticket atualizado com sucesso"),await J()}catch(r){var e,a;n.oR.error((null==r||null==(a=r.response)||null==(e=a.data)?void 0:e.error)||"Erro ao atualizar ticket")}finally{U(!1)}}},X=async e=>{if(e.preventDefault(),S.trim()||0!==T.length){L(!0);try{let e=S.trim()||(T.length>0?"Anexos enviados":"");await x.$p.ticket.addMensagem(W,{mensagem:e},T.length>0?T:void 0),D(""),I([]),G.current&&(G.current.value=""),n.oR.success("Mensagem enviada com sucesso"),await J()}catch(e){var a,r;n.oR.error((null==e||null==(r=e.response)||null==(a=r.data)?void 0:a.error)||"Erro ao enviar mensagem")}finally{L(!1)}}};if(C)return(0,s.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,s.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Carregando ticket..."})});if(!M)return null;let Y=[{value:"ABERTO",label:"Aberto"},{value:"EM_ANDAMENTO",label:"Em Andamento"},{value:"RESOLVIDO",label:"Resolvido"},{value:"FECHADO",label:"Fechado"}],Z=[{value:"BAIXA",label:"Baixa"},{value:"MEDIA",label:"M\xe9dia"},{value:"ALTA",label:"Alta"},{value:"URGENTE",label:"Urgente"}];return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)(d.A,{variant:"outline",onClick:()=>j.push("/dashboard/admin/tickets"),startIcon:(0,s.jsx)(p.YJ,{className:"w-5 h-5"}),"aria-label":"Voltar para lista de tickets",children:"Voltar"}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:M.titulo}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-2 flex-wrap",children:[(0,s.jsx)(h.A,{color:function(e){switch(e){case"ABERTO":default:return"info";case"EM_ANDAMENTO":return"warning";case"RESOLVIDO":return"success";case"FECHADO":return"error"}}(M.status),children:function(e){switch(e){case"ABERTO":return"Aberto";case"EM_ANDAMENTO":return"Em Andamento";case"RESOLVIDO":return"Resolvido";case"FECHADO":return"Fechado";default:return e}}(M.status)}),(0,s.jsx)(h.A,{color:"info",children:function(e){switch(e){case"PROBLEMA":return"Problema";case"AJUDA":return"Ajuda";case"MELHORIA":return"Melhoria";case"SUGESTAO":return"Sugest\xe3o";default:return e}}(M.tipo)}),(0,s.jsx)(h.A,{color:"warning",children:function(e){switch(e){case"BAIXA":return"Baixa";case"MEDIA":return"M\xe9dia";case"ALTA":return"Alta";case"URGENTE":return"Urgente";default:return e}}(M.prioridade)})]})]})]}),(0,s.jsx)(c.Z,{className:"p-4",children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Descri\xe7\xe3o:"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1 whitespace-pre-wrap",children:M.descricao})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Criado por:"}),(0,s.jsxs)("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:[(null==(e=M.criador)?void 0:e.nome)||"N/A"," (",(null==(a=M.criador)?void 0:a.email)||"N/A",")"]})]}),M.empresa&&(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Empresa:"}),(0,s.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:M.empresa.nome})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Data de cria\xe7\xe3o:"}),(0,s.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:(0,g.Yq)(M.createdAt)})]})]}),(0,s.jsxs)("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,s.jsx)("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Gerenciar Ticket"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(u.A,{htmlFor:"status",children:"Status"}),(0,s.jsx)(o.A,{id:"status",options:Y,value:Y.find(e=>e.value===z),onChange:e=>F(null==e?void 0:e.value),isSearchable:!1,"aria-label":"Status do ticket"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(u.A,{htmlFor:"prioridade",children:"Prioridade"}),(0,s.jsx)(o.A,{id:"prioridade",options:Z,value:Z.find(e=>e.value===P),onChange:e=>_(null==e?void 0:e.value),isSearchable:!1,"aria-label":"Prioridade do ticket"})]})]}),(0,s.jsx)(d.A,{variant:"primary",onClick:K,disabled:V||M.status===z&&M.prioridade===P,className:"mt-4","aria-label":"Atualizar status e prioridade",children:V?"Atualizando...":"Atualizar Status"})]})]})}),(0,s.jsxs)(c.Z,{className:"p-0 overflow-hidden",children:[(0,s.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:(0,s.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:["Mensagens (",(null==(t=M.mensagens)?void 0:t.length)||0,")"]})}),(0,s.jsx)("div",{className:"px-6 py-4 max-h-[600px] min-h-[400px] overflow-y-auto bg-gray-50 dark:bg-gray-900/50",children:M.mensagens&&M.mensagens.length>0?(0,s.jsxs)(s.Fragment,{children:[M.mensagens.map(e=>(0,s.jsx)(m.A,{mensagem:e},e.id)),(0,s.jsx)("div",{ref:q})]}):(0,s.jsx)("div",{className:"flex items-center justify-center h-full min-h-[300px]",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center",children:(0,s.jsx)("svg",{className:"w-8 h-8 text-gray-400 dark:text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Nenhuma mensagem ainda. Seja o primeiro a comentar!"})]})})}),(0,s.jsx)("div",{className:"px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",children:(0,s.jsxs)("form",{onSubmit:X,className:"space-y-3",children:[T.length>0&&(0,s.jsx)("div",{className:"flex flex-wrap gap-2",children:T.map((e,a)=>(0,s.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm",children:[(0,s.jsxs)("span",{className:"text-gray-700 dark:text-gray-300 truncate max-w-[200px]",children:[e.name," (",(e.size/1024/1024).toFixed(2)," MB)"]}),(0,s.jsx)("button",{type:"button",onClick:()=>{I(e=>e.filter((e,r)=>r!==a))},className:"text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-1","aria-label":"Remover ".concat(e.name),children:"âœ•"})]},a))}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("textarea",{id:"mensagem",value:S,onChange:e=>D(e.target.value),rows:3,className:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white resize-none",placeholder:"Digite sua mensagem...","aria-label":"Mensagem do ticket",onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),(S.trim()||T.length>0)&&!B&&X(e))}})}),(0,s.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,s.jsx)("input",{ref:G,type:"file",multiple:!0,onChange:e=>{if(e.target.files){let a=Array.from(e.target.files);if(a.length>5)return void n.oR.error("M\xe1ximo de 5 arquivos permitidos");I(a)}},accept:"image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.csv",className:"hidden","aria-label":"Anexar arquivos",id:"file-input-ticket-admin"}),(0,s.jsx)(d.A,{type:"button",variant:"outline",className:"h-full flex items-center justify-center","aria-label":"Anexar arquivo",onClick:()=>{var e;return null==(e=G.current)?void 0:e.click()},children:(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})})}),(0,s.jsx)(d.A,{type:"submit",variant:"primary",disabled:B||!S.trim()&&0===T.length,className:"h-full flex items-center justify-center","aria-label":"Enviar mensagem",children:B?(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"M\xe1ximo 5 arquivos, 10MB cada. Formatos: imagens, PDFs, documentos do Office, textos."})]})})]})]})}[x,m,v,f]=j.then?(await j)():j,t()}catch(e){t(e)}})},80650:(e,a,r)=>{Promise.resolve().then(r.bind(r,24420))}},e=>{e.O(0,[3598,2663,5889,7750,1356,2976,4691,1899,8469,8441,1255,7358],()=>e(e.s=80650)),_N_E=e.O()}]);