generator client {
  provider = "prisma-client-js"
  output   = "../dist/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// enums
enum Role {
  SUPERADMIN
  ADMIN
  GESTOR
  VENDEDOR
  CLIENTE
}

enum TipoMovimento {
  ENTRADA
  SAIDA
}

enum StatusCotacao {
  EM_ANDAMENTO
  FECHADA
}

enum TipoCotacao {
  IMEDIATA
  PROGRAMADA
}

enum StatusPagamento {
  PENDENTE
  PAGO
}

enum StatusVendaFinal {
  PENDING
  APPROVED
  CANCELLED
}

enum TipoMensagem {
  A_VENCER
  NO_DIA
  VENCIDA
  COMPROVANTE
  MANUAL
  FINALIZACAO
}

enum TipoPagamento {
  PIX
  BOLETO
}

enum TipoNotificacao {
  VENCIMENTO_EMPRESA
  PLANO_PAGO
  COBRANCA_GERADA
  FATURA_PAGA
  PARCELA_PAGA
  MANUAL
  TICKET_MENSAGEM
}

enum TipoTicket {
  PROBLEMA
  AJUDA
  MELHORIA
  SUGESTAO
}

enum StatusTicket {
  ABERTO
  EM_ANDAMENTO
  RESOLVIDO
  FECHADO
}

enum PrioridadeTicket {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

// models
model Empresa {
  id                   Int                   @id @default(autoincrement())
  uuid                 String                @unique @default(uuid())
  nome                 String
  cpfCnpj              String?
  celular              String?
  cep                  String?
  cidade               String?
  estado               String?
  bairro               String?
  rua                  String?
  numero               String?
  vencimento           DateTime
  usuarios             User[]
  clientes             Cliente[]
  conexoes             Conexao[]
  produtos             Produto[]
  fornecedores         Fornecedor[]
  cotacoes             Cotacao[]
  contas               ContaPagar[]
  vendas               Venda[]
  mensagens            Mensagem[]
  gateways             Gateway[]
  categoriasProdutos   CategoriaProduto[]
  categoriasFornecedor CategoriaFornecedor[]
  MovimentoEstoque     MovimentoEstoque[]
  VendaProduto         VendaProduto[]
  VendaFinal           VendaFinal[]
  CompraPlanoEmpresa   CompraPlanoEmpresa[]
  notificacoes         Notificacao[]
  tickets              Ticket[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  ItemCotacao ItemCotacao[]

  @@unique([cpfCnpj])
  @@index([vencimento])
}

model User {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  celular   String
  role      Role
  token     String   @unique @default(uuid())
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
  empresaId Int?
  vendas    Venda[]
  cliente   Cliente? @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  clienteId Int?     @unique

  notificacoes    Notificacao[]
  ticketsCriados  Ticket[]
  ticketMensagens TicketMensagem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role, empresaId])
  @@index([clienteId])
  @@index([token])
}

model Cliente {
  id          Int       @id @default(autoincrement())
  nome        String
  email       String?
  celular     String?
  nascimento  DateTime?
  cpfCnpj     String?
  cep         String?
  bairro      String?
  rua         String?
  numero      String?
  complemento String?
  cidade      String?
  estado      String?
  extras      Json?
  empresa     Empresa   @relation(fields: [empresaId], references: [id])
  empresaId   Int
  Venda       Venda[]
  user        User?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cpfCnpj, empresaId])
  @@index([empresaId, nome])
}

model CategoriaProduto {
  id        Int       @id @default(autoincrement())
  nome      String
  produtos  Produto[]
  empresa   Empresa   @relation(fields: [empresaId], references: [id])
  empresaId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nome, empresaId])
  @@index([empresaId])
}

model Produto {
  id          Int                @id @default(autoincrement())
  sku         String
  nome        String
  descricao   String
  valor       Decimal            @db.Decimal(10, 2)
  estoque     Int
  categoria   CategoriaProduto   @relation(fields: [categoriaId], references: [id])
  categoriaId Int
  empresa     Empresa            @relation(fields: [empresaId], references: [id])
  empresaId   Int
  movimentos  MovimentoEstoque[]
  vendas      VendaProduto[]
  cotacoes    ItemCotacao[]
  ContaPagar  ContaPagar[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku, empresaId])
  @@index([empresaId, sku])
  @@index([categoriaId])
  @@index([estoque])
}

model MovimentoEstoque {
  id            Int           @id @default(autoincrement())
  tipo          TipoMovimento
  quantidade    Int
  valorUnitario Decimal       @db.Decimal(10, 2)
  data          DateTime
  produto       Produto       @relation(fields: [produtoId], references: [id])
  produtoId     Int
  fornecedor    Fornecedor?   @relation(fields: [fornecedorId], references: [id])
  fornecedorId  Int?
  empresa       Empresa       @relation(fields: [empresaId], references: [id])
  empresaId     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, produtoId])
  @@index([data])
  @@index([tipo])
}

model CategoriaFornecedor {
  id           Int          @id @default(autoincrement())
  nome         String
  fornecedores Fornecedor[]
  empresa      Empresa      @relation(fields: [empresaId], references: [id])
  empresaId    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nome, empresaId])
  @@index([empresaId, nome])
}

model Fornecedor {
  id               Int                 @id @default(autoincrement())
  nome             String
  cpfCnpj          String
  email            String?
  celular          String?
  observacoes      String?
  categoria        CategoriaFornecedor @relation(fields: [categoriaId], references: [id])
  categoriaId      Int
  empresa          Empresa             @relation(fields: [empresaId], references: [id])
  empresaId        Int
  cotacoes         ItemCotacao[]
  contas           ContaPagar[]
  MovimentoEstoque MovimentoEstoque[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cpfCnpj, empresaId])
  @@index([empresaId, cpfCnpj])
  @@index([categoriaId])
}

model Cotacao {
  id             Int           @id @default(autoincrement())
  uuid           String        @unique @default(uuid())
  nome           String
  descricao      String?
  dataAbertura   DateTime
  dataFechamento DateTime?
  status         StatusCotacao
  tipo           TipoCotacao
  empresa        Empresa       @relation(fields: [empresaId], references: [id])
  empresaId      Int
  itens          ItemCotacao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, status])
  @@index([dataAbertura])
}

model ItemCotacao {
  id            Int        @id @default(autoincrement())
  fornecedor    Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId  Int
  produto       Produto    @relation(fields: [produtoId], references: [id])
  produtoId     Int
  valorUnitario Decimal    @db.Decimal(10, 2)
  quantidade    Int
  aprovada      Boolean
  vencedora     Boolean
  cotacao       Cotacao    @relation(fields: [cotacaoId], references: [id], onDelete: Cascade)
  cotacaoId     Int
  empresa       Empresa    @relation(fields: [empresaId], references: [id])
  empresaId     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cotacaoId])
  @@index([fornecedorId, produtoId])
}

model ContaPagar {
  id           Int             @id @default(autoincrement())
  nome         String
  observacao   String?
  valor        Decimal         @db.Decimal(10, 2)
  vencimento   DateTime
  status       StatusPagamento
  fornecedor   Fornecedor?     @relation(fields: [fornecedorId], references: [id])
  fornecedorId Int?
  produto      Produto?        @relation(fields: [produtoId], references: [id])
  produtoId    Int?
  empresa      Empresa         @relation(fields: [empresaId], references: [id])
  empresaId    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId])
  @@index([vencimento])
  @@index([status])
}

model VendaProduto {
  id            Int      @id @default(autoincrement())
  produto       Produto  @relation(fields: [produtoId], references: [id])
  produtoId     Int
  quantidade    Int
  valorUnitario Decimal  @db.Decimal(10, 2)
  valorTotal    Decimal  @db.Decimal(10, 2)
  vencimento    DateTime
  venda         Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  vendaId       Int
  empresa       Empresa  @relation(fields: [empresaId], references: [id])
  empresaId     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, produtoId])
  @@index([vendaId])
  @@index([vencimento])
}

model Venda {
  id                    Int              @id @default(autoincrement())
  uuid                  String           @unique @default(uuid())
  valor                 Decimal          @db.Decimal(10, 2)
  status                StatusPagamento? @default(PENDENTE)
  recorrencia           Int?             @default(0)
  quantidadeRecorrencia Int?             @default(0)
  valorTotal            Decimal          @db.Decimal(10, 2)
  inicio                DateTime
  fim                   DateTime
  vendedor              User             @relation(fields: [vendedorId], references: [id])
  vendedorId            Int
  empresa               Empresa          @relation(fields: [empresaId], references: [id])
  empresaId             Int
  produtos              VendaProduto[]
  finais                VendaFinal[]
  cliente               Cliente          @relation(fields: [clienteId], references: [id])
  clienteId             Int
  gateway               Gateway?         @relation(fields: [gatewayId], references: [id])
  gatewayId             Int?
  conexao               Conexao?         @relation(fields: [conexaoId], references: [id], onDelete: SetNull)
  conexaoId             Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId])
  @@index([status])
  @@index([vendedorId])
  @@index([clienteId])
  @@index([inicio, fim])
}

model VendaFinal {
  id            Int              @id @default(autoincrement())
  uuid          String           @unique @default(uuid())
  valor         Decimal          @db.Decimal(10, 2)
  status        StatusVendaFinal
  id_payment    String?
  type          TipoPagamento
  copiacola     String?
  qrcode        String?          @db.Text
  codigobarra   String?
  vencimento    DateTime
  dataPagamento DateTime?
  venda         Venda            @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  vendaId       Int
  empresa       Empresa          @relation(fields: [empresaId], references: [id])
  empresaId     Int
  gateway       Gateway          @relation(fields: [gatewayId], references: [id])
  gatewayId     Int
  conexao       Conexao?         @relation(fields: [conexaoId], references: [id], onDelete: SetNull)
  conexaoId     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, vendaId])
  @@index([status])
  @@index([vencimento])
  @@index([type])
}

model Conexao {
  id        Int            @id @default(autoincrement())
  nome      String
  status    ConexaoStatus? @default(connecting)
  numero    String?
  tokenId   String         @unique
  isDefault Boolean        @default(false)
  empresa   Empresa        @relation(fields: [empresaId], references: [id])
  empresaId Int

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  Venda      Venda[]
  VendaFinal VendaFinal[]

  // @@unique([numero, empresaId])
  @@index([empresaId])
}

enum ConexaoStatus {
  open
  connecting
  close
}

model Mensagem {
  id        Int          @id @default(autoincrement())
  mensagem  String       @db.Text
  tipo      TipoMensagem
  status    Boolean
  hora      String
  dias      Int
  empresa   Empresa      @relation(fields: [empresaId], references: [id])
  empresaId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId])
  @@index([tipo, status])
}

model Plano {
  id                 Int                  @id @default(autoincrement())
  nome               String
  valor              Decimal              @db.Decimal(10, 2)
  dias               Int
  status             PlanoStatus          @default(ATIVO)
  CompraPlanoEmpresa CompraPlanoEmpresa[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([valor])
  @@index([status])
}

model CompraPlanoEmpresa {
  id            Int              @id @default(autoincrement())
  empresa       Empresa          @relation(fields: [empresaId], references: [id])
  empresaId     Int
  plano         Plano            @relation(fields: [planoId], references: [id])
  planoId       Int
  status        StatusPagamento? @default(PENDENTE)
  valor         Decimal          @db.Decimal(10, 2)
  gateway       Gateway?         @relation(fields: [gatewayId], references: [id])
  gatewayId     Int?
  id_payment    String?
  copiacola     String?
  qrcode        String?          @db.Text
  codigobarra   String?
  vencimento    DateTime?
  dataPagamento DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, planoId])
  @@index([status])
  @@index([vencimento])
}

model Gateway {
  id        Int         @id @default(autoincrement())
  gateway   gatewayType
  nome      String?     @default("Default")
  descricao String?
  isDefault Boolean?    @default(false)
  dados     Json
  empresa   Empresa?    @relation(fields: [empresaId], references: [id])
  empresaId Int?

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Venda              Venda[]
  VendaFinal         VendaFinal[]
  CompraPlanoEmpresa CompraPlanoEmpresa[]

  @@index([empresaId])
  @@index([gateway])
}

enum gatewayType {
  MERCADO_PAGO
  OMIE
  ASAAS
  CORA
  EFIPAY
}

enum PlanoStatus {
  ATIVO
  INATIVO
}

model Notificacao {
  id          Int             @id @default(autoincrement())
  titulo      String
  mensagem    String          @db.Text
  tipo        TipoNotificacao
  lida        Boolean         @default(false)
  actionLink  String?
  actionLabel String?
  empresa     Empresa?        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId   Int?
  user        User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int?
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empresaId, lida])
  @@index([userId, lida])
  @@index([tipo])
  @@index([createdAt])
}

model Ticket {
  id         Int              @id @default(autoincrement())
  uuid       String           @unique @default(uuid())
  titulo     String
  descricao  String           @db.Text
  tipo       TipoTicket
  status     StatusTicket     @default(ABERTO)
  prioridade PrioridadeTicket @default(MEDIA)
  anexos     Json?
  criador    User             @relation(fields: [criadorId], references: [id])
  criadorId  Int
  empresa    Empresa          @relation(fields: [empresaId], references: [id])
  empresaId  Int
  mensagens  TicketMensagem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([criadorId])
  @@index([empresaId])
  @@index([status])
  @@index([tipo])
  @@index([prioridade])
  @@index([createdAt])
}

model TicketMensagem {
  id       Int    @id @default(autoincrement())
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId Int
  user     User   @relation(fields: [userId], references: [id])
  userId   Int
  mensagem String @db.Text
  anexos   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}
